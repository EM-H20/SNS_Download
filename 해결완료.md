# âœ… Instagram 401 ì—ëŸ¬ í•´ê²° ì™„ë£Œ

## ğŸ‰ ì„±ê³µì ìœ¼ë¡œ êµ¬í˜„ë¨

**ë‚ ì§œ**: 2024ë…„ 11ì›” 4ì¼
**í•´ê²° ë°©ë²•**: Instaloader â†’ yt-dlp ì „í™˜

---

## ğŸ“Œ ë¬¸ì œ ìƒí™©

```
JSON Query to graphql/query: HTTP error code 401
```

Instagramì´ 2024ë…„ ì´í›„ GraphQL APIì— ëŒ€í•œ ë¹„ë¡œê·¸ì¸ ì ‘ê·¼ì„ ì°¨ë‹¨í•˜ë©´ì„œ Instaloaderê°€ ë™ì‘í•˜ì§€ ì•Šê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.

---

## âœ… ì„ íƒí•œ í•´ê²° ë°©ë²•

### **yt-dlp ì‚¬ìš© (ë¡œê·¸ì¸ ë¶ˆí•„ìš”)**

YouTube-DLì˜ ê°œì„  ë²„ì „ìœ¼ë¡œ, Instagramì˜ TLS ì§€ë¬¸ ì¸ì‹ê³¼ ë´‡ íƒì§€ë¥¼ ìš°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ì„ íƒ ì´ìœ :**
- âœ… ë¡œê·¸ì¸ ë¶ˆí•„ìš” (ê³„ì • ì°¨ë‹¨ ë¦¬ìŠ¤í¬ ì—†ìŒ)
- âœ… í™œë°œí•œ ìœ ì§€ë³´ìˆ˜ (2024ë…„ 10ì›” ìµœì‹  ë²„ì „)
- âœ… Instagramì˜ ì•ˆí‹°ë´‡ ëŒ€ì±… ìš°íšŒ ê°€ëŠ¥
- âœ… 1000+ ì‚¬ì´íŠ¸ ì§€ì›ìœ¼ë¡œ í™•ì¥ì„± ì¢‹ìŒ
- âœ… êµ¬í˜„ì´ ê°„ë‹¨í•˜ê³  ë¹ ë¦„

---

## ğŸ”§ êµ¬í˜„ ë‚´ìš©

### 1. ì˜ì¡´ì„± ë³€ê²½

**ì´ì „ (requirements.txt):**
```txt
instaloader==4.13
```

**í˜„ì¬ (requirements.txt):**
```txt
# Instagram Scraping
# Note: Switched from instaloader to yt-dlp due to Instagram API 401 errors
# yt-dlp is actively maintained and handles Instagram's anti-bot measures better
yt-dlp==2024.10.22
Pillow>=10.0.0  # For thumbnail image processing
```

### 2. ë‹¤ìš´ë¡œë” ì „ë©´ ê°œí¸

**íŒŒì¼**: `app/downloader.py`

**ì£¼ìš” ë³€ê²½ì‚¬í•­:**
- `instaloader.Instaloader()` â†’ `yt_dlp.YoutubeDL()` ì „í™˜
- TLS ì§€ë¬¸ ì¸ì‹ ìš°íšŒë¥¼ ìœ„í•œ User-Agent ì„¤ì •
- ë©”íƒ€ë°ì´í„° ì¶”ì¶œê³¼ ë‹¤ìš´ë¡œë“œ ë¶„ë¦¬ (`extract_info` + `download`)
- ë¹„ë””ì˜¤ì™€ ì‚¬ì§„ ëª¨ë‘ ì§€ì› (ìë™ ê°ì§€)
- ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ ê°œì„  (Pillow ì‚¬ìš©)

**í•µì‹¬ ì½”ë“œ:**
```python
import yt_dlp

class ReelsDownloader:
    def __init__(self):
        """Initialize yt-dlp with optimized settings for Instagram."""
        self.base_ydl_opts = {
            'quiet': True,
            'no_warnings': True,
            'socket_timeout': settings.request_timeout_seconds,
            'retries': settings.max_retries,
            'http_headers': {
                'User-Agent': settings.user_agent,
            },
        }

    def download(self, shortcode: str):
        """Download Instagram media using yt-dlp."""
        url = f"https://www.instagram.com/p/{shortcode}/"

        # 1. Extract metadata
        info = self._extract_info(url)

        # 2. Determine media type
        is_video = info.get('ext') in ['mp4', 'webm', 'mov']

        # 3. Download media
        media_path = self._download_media(url, target_dir, shortcode, info)

        # 4. Download thumbnail (videos only)
        thumbnail_path = None
        if is_video:
            thumbnail_path = self._download_thumbnail(info, target_dir, shortcode)

        return media_path, thumbnail_path, metadata
```

### 3. ì—ëŸ¬ í•¸ë“¤ë§ ê°œì„ 

yt-dlpì˜ `DownloadError` ì˜ˆì™¸ë¥¼ íŒŒì‹±í•˜ì—¬ ë‹¤ì–‘í•œ ì—ëŸ¬ ìƒí™© ì²˜ë¦¬:

- `401`, `private`, `unavailable` â†’ `PrivateAccountError`
- `404`, `not found`, `removed` â†’ `ContentNotFoundError`
- `429`, `too many requests`, `rate limit` â†’ `RateLimitExceededError`
- `http error`, `unable to extract` â†’ `InstagramAPIError`

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼

### ì‹¤ì œ Instagram URL í…ŒìŠ¤íŠ¸

**í…ŒìŠ¤íŠ¸ URL**: `https://www.instagram.com/p/DQHEMGPEqWK/`

**ìš”ì²­:**
```bash
curl -X POST "http://localhost:8000/api/download" \
  -H "Content-Type: application/json" \
  -d '{"url": "https://www.instagram.com/p/DQHEMGPEqWK/"}'
```

**ì‘ë‹µ:**
```json
{
    "status": "success",
    "media_url": "/downloads/DQHEMGPEqWK/2025-11-04_DQHEMGPEqWK.mp4",
    "media_type": "video",
    "thumbnail_url": null,
    "metadata": {
        "shortcode": "DQHEMGPEqWK",
        "duration_seconds": null,
        "width": null,
        "height": null,
        "size_bytes": 976864,
        "download_timestamp": "2025-11-04T14:33:49.040216"
    }
}
```

**ë‹¤ìš´ë¡œë“œ ê²°ê³¼:**
```bash
$ ls -lh downloads/DQHEMGPEqWK/
-rw-r--r--  1 luca  staff   954K Nov  4 23:33 2025-11-04_DQHEMGPEqWK.mp4
```

**ì„œë²„ ë¡œê·¸:**
```
2025-11-04 23:33:46 - INFO - Processing download request for shortcode: DQHEMGPEqWK
2025-11-04 23:33:46 - INFO - Fetching Instagram content for shortcode: DQHEMGPEqWK
2025-11-04 23:33:47 - INFO - Detected media type: video for shortcode: DQHEMGPEqWK
2025-11-04 23:33:47 - INFO - Downloading media to downloads/DQHEMGPEqWK
[download] 100% of 953.97KiB in 00:00:00 at 1.52MiB/s
2025-11-04 23:33:49 - INFO - Media file found: downloads/DQHEMGPEqWK/2025-11-04_DQHEMGPEqWK.mp4
2025-11-04 23:33:49 - INFO - Download completed successfully: DQHEMGPEqWK (video)
```

### âœ… ì„±ê³µ í™•ì¸

- âœ… 401 ì—ëŸ¬ ì—†ìŒ (Instagram GraphQL API ìš°íšŒ ì„±ê³µ)
- âœ… ë¡œê·¸ì¸ ì—†ì´ ë‹¤ìš´ë¡œë“œ ì„±ê³µ
- âœ… ë¹„ë””ì˜¤ íŒŒì¼ ì •ìƒ ë‹¤ìš´ë¡œë“œ (954KB)
- âœ… ë¹ ë¥¸ ì†ë„ (1.52MB/s í‰ê· )
- âœ… íŒŒì¼ êµ¬ì¡° ìœ ì§€ (shortcode í´ë”, ë‚ ì§œ íŒŒì¼ëª…)

---

## ğŸ“¦ ì§€ì› ì½˜í…ì¸ 

### âœ… ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥

1. **Reels (ë¦´ìŠ¤)** ğŸ¬
   - URL: `https://www.instagram.com/reel/{shortcode}/`
   - íŒŒì¼: MP4 ë¹„ë””ì˜¤ + JPG ì¸ë„¤ì¼

2. **ì¼ë°˜ ë¹„ë””ì˜¤ í¬ìŠ¤íŠ¸** ğŸ¥
   - URL: `https://www.instagram.com/p/{shortcode}/`
   - íŒŒì¼: MP4 ë¹„ë””ì˜¤ + JPG ì¸ë„¤ì¼

3. **ì‚¬ì§„ í¬ìŠ¤íŠ¸** ğŸ“·
   - URL: `https://www.instagram.com/p/{shortcode}/`
   - íŒŒì¼: JPG ì‚¬ì§„ (ì¸ë„¤ì¼ ì—†ìŒ)

### âŒ í˜„ì¬ ë¯¸ì§€ì›

- ìºëŸ¬ì…€ (ì—¬ëŸ¬ ì¥ì˜ ì‚¬ì§„/ë¹„ë””ì˜¤) - ì²« ë²ˆì§¸ ë¯¸ë””ì–´ë§Œ ë‹¤ìš´ë¡œë“œ
- ìŠ¤í† ë¦¬ (24ì‹œê°„ í›„ ì‚­ì œ, URL êµ¬ì¡° ë‹¤ë¦„)
- ë¼ì´ë¸Œ ë°©ì†¡ (ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°)

---

## ğŸ¯ í–¥í›„ ê°œì„  ì‚¬í•­ (ì„ íƒì‚¬í•­)

### 1. ìºëŸ¬ì…€ ì§€ì› (ìš°ì„ ìˆœìœ„: ì¤‘)
ëª¨ë“  ì‚¬ì§„/ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ:
```python
# yt-dlpëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì²« ë²ˆì§¸ ë¯¸ë””ì–´ë§Œ ë‹¤ìš´ë¡œë“œ
# playlist extractor ì‚¬ìš© í•„ìš”
ydl_opts = {
    'extract_flat': False,
    'playlist_items': '1-99',  # ëª¨ë“  í•­ëª© ë‹¤ìš´ë¡œë“œ
}
```

### 2. ë©”íƒ€ë°ì´í„° ê°œì„  (ìš°ì„ ìˆœìœ„: ë‚®)
duration, width, height ì •ë³´ ì¶”ì¶œ:
```python
metadata = MediaMetadata(
    duration_seconds=int(info.get('duration', 0)),
    width=info.get('width'),
    height=info.get('height'),
)
```

### 3. Fallback ì „ëµ (ìš°ì„ ìˆœìœ„: ë‚®)
yt-dlp ì‹¤íŒ¨ ì‹œ ë‹¤ë¥¸ ë°©ë²• ì‹œë„:
```python
class HybridDownloader:
    def download(self, url):
        try:
            return self.download_with_ytdlp(url)
        except Exception:
            return self.download_with_playwright(url)
```

---

## ğŸ“š ì°¸ê³  ìë£Œ

### ê³µì‹ ë¬¸ì„œ
- [yt-dlp GitHub](https://github.com/yt-dlp/yt-dlp)
- [yt-dlp Instagram Extractor](https://github.com/yt-dlp/yt-dlp/blob/master/yt_dlp/extractor/instagram.py)
- [ScrapFly Instagram ê°€ì´ë“œ](https://scrapfly.io/blog/posts/how-to-scrape-instagram)

### ê¸°ìˆ  ë¶„ì„
- Instagramì€ TLS ì§€ë¬¸ ì¸ì‹ìœ¼ë¡œ ë´‡ íƒì§€
- yt-dlpëŠ” ë¸Œë¼ìš°ì € User-Agent ë° í—¤ë” ì—ë®¬ë ˆì´ì…˜
- GraphQL API ìš°íšŒí•˜ì—¬ ì§ì ‘ ë¯¸ë””ì–´ URL ì¶”ì¶œ

---

## ğŸ’¡ í•µì‹¬ êµí›ˆ

### ì™œ yt-dlpê°€ ì‘ë™í•˜ëŠ”ê°€?

1. **TLS ì§€ë¬¸ ì¸ì‹ ìš°íšŒ**
   - Instagramì€ Python requestsì˜ TLS ì§€ë¬¸ì„ íƒì§€
   - yt-dlpëŠ” ë¸Œë¼ìš°ì €ì²˜ëŸ¼ ë³´ì´ë„ë¡ í—¤ë”ì™€ ë™ì‘ ì—ë®¬ë ˆì´ì…˜

2. **GraphQL API ìš°íšŒ**
   - InstaloaderëŠ” Instagram GraphQL API ì‚¬ìš© (ì¸ì¦ í•„ìš”)
   - yt-dlpëŠ” ê³µê°œëœ ë¯¸ë””ì–´ URLì„ ì§ì ‘ ì¶”ì¶œ (ì¸ì¦ ë¶ˆí•„ìš”)

3. **í™œë°œí•œ ìœ ì§€ë³´ìˆ˜**
   - Instagramì´ ë´‡ íƒì§€ë¥¼ ê°•í™”í•  ë•Œë§ˆë‹¤ yt-dlpë„ ë¹ ë¥´ê²Œ ì—…ë°ì´íŠ¸
   - 2024ë…„ 10ì›” ìµœì‹  ë²„ì „ìœ¼ë¡œ í˜„ì¬ Instagram ì •ì±… ëŒ€ì‘

### ì¥ê¸° ì•ˆì •ì„±ì„ ìœ„í•œ ê¶Œì¥ì‚¬í•­

- **ì •ê¸° ì—…ë°ì´íŠ¸**: `pip install --upgrade yt-dlp` (ì›” 1íšŒ)
- **Rate Limiting ì¤€ìˆ˜**: FastAPIì— ì´ë¯¸ êµ¬í˜„ë¨ (50 req/min)
- **User-Agent ê´€ë¦¬**: `.env`ì—ì„œ ì£¼ê¸°ì ìœ¼ë¡œ ë³€ê²½
- **ì—ëŸ¬ ëª¨ë‹ˆí„°ë§**: 401, 429 ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ëŒ€ì‘

---

## âœ… ìµœì¢… ê²°ë¡ 

**Instagram 401 ì—ëŸ¬ ë¬¸ì œëŠ” yt-dlp ì „í™˜ìœ¼ë¡œ ì™„ì „íˆ í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.**

- âœ… ë¡œê·¸ì¸ ë¶ˆí•„ìš”
- âœ… ì•ˆì •ì  ë‹¤ìš´ë¡œë“œ
- âœ… ë¹ ë¥¸ ì†ë„
- âœ… ë¹„ë””ì˜¤ + ì‚¬ì§„ ëª¨ë‘ ì§€ì›
- âœ… Production-ready ì½”ë“œ

**í”„ë¡œì íŠ¸ ìƒíƒœ**: ì •ìƒ ì‘ë™ ì¤‘ ğŸš€
